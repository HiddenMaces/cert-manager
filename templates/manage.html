{% extends "layout.html" %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-2 space-y-6">
        <div class="flex justify-between items-center pb-4 border-b dark:border-s1-700">
            <h1 class="text-2xl font-bold">{{ fqdn }}</h1>
            <a href="/cert/delete/{{ fqdn }}" onclick="return confirm('Are you sure? This deletes the entire directory for this certificate.')" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded shadow transition">
                Delete Certificate
            </a>
        </div>

        <div class="bg-white dark:bg-s1-800 rounded-lg shadow p-6 border dark:border-s1-700">
            <h3 class="text-lg font-bold mb-4">Certificate Details</h3>
            <p class="text-xs text-gray-500 mb-4">Modify the parameters below to regenerate the CSR. <br><span class="text-red-500">Note: Changing the FQDN will rename the certificate directory and files.</span></p>
            
            <form action="/cert/update_details/{{ fqdn }}" method="POST" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Common Name (FQDN)</label>
                        <input type="text" name="cn" value="{{ csr.cn }}" class="w-full p-2 rounded border dark:bg-s1-900 dark:border-s1-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Country (2 Letter)</label>
                        <input type="text" name="c" value="{{ csr.c }}" class="w-full p-2 rounded border dark:bg-s1-900 dark:border-s1-700 dark:text-white" maxlength="2">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Organization</label>
                        <input type="text" name="o" value="{{ csr.o }}" class="w-full p-2 rounded border dark:bg-s1-900 dark:border-s1-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Org Unit (OU)</label>
                        <input type="text" name="ou" value="{{ csr.ou }}" class="w-full p-2 rounded border dark:bg-s1-900 dark:border-s1-700 dark:text-white">
                    </div>
                </div>
                <div class="text-right mt-2">
                    <button type="submit" class="px-3 py-1 bg-s1-500 hover:bg-s1-400 text-white text-sm rounded transition">Update Details & CSR</button>
                </div>
            </form>
        </div>

        <div class="bg-white dark:bg-s1-800 rounded-lg shadow p-6 border dark:border-s1-700">
            <h3 class="text-lg font-bold mb-2">Extension File (v3.ext)</h3>
            <p class="text-xs text-gray-500 mb-2">Edit this to add Subject Alternative Names (SANs) before signing.</p>
            <form action="/cert/update_ext/{{ fqdn }}" method="POST">
                <textarea name="ext_content" rows="8" class="w-full font-mono text-sm p-3 rounded border dark:bg-s1-900 dark:border-s1-700 dark:text-gray-300">{{ ext_content }}</textarea>
                <div class="mt-2 text-right">
                    <button type="submit" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded">Save Extensions</button>
                </div>
            </form>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white dark:bg-s1-800 rounded-lg shadow p-6 border dark:border-s1-700">
            <h3 class="text-lg font-bold mb-4">Signing Actions</h3>
            
            {% if has_crt %}
                <div class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 p-3 rounded mb-4 text-center">
                    Certificate Signed (.crt exists)
                </div>
                <p class="text-xs text-center text-gray-500 mb-4">You can re-sign if you changed extensions.</p>
            {% else %}
                <div class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 p-3 rounded mb-4 text-center">
                    Pending Signature
                </div>
            {% endif %}

            <div class="space-y-3">
                <button onclick="document.getElementById('passwordModal').classList.remove('hidden')" class="block w-full text-center py-2 bg-s1-500 hover:bg-s1-400 text-white rounded shadow transition">
                    Sign with Root CA
                </button>
                
                <a href="/cert/sign_self/{{ fqdn }}" class="block w-full text-center py-2 border border-s1-500 text-s1-500 dark:text-s1-400 hover:bg-s1-500 hover:text-white rounded transition">Self-Sign</a>
            </div>
        </div>

        <div class="bg-white dark:bg-s1-800 rounded-lg shadow p-6 border dark:border-s1-700">
            <h3 class="text-lg font-bold mb-4">Export .pem/.pf12</h3>
            {% if has_crt %}
                <form action="/cert/create_p12/{{ fqdn }}" method="POST">
                    <label class="text-xs uppercase font-bold text-gray-500">PEM/PF12 Password</label>
                    <input type="password" name="password" class="w-full p-2 mb-2 rounded border dark:bg-s1-900 dark:border-s1-700">
                    <button type="submit" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">Create .p12</button>
                </form>
                {% if has_p12 %}
                    <p class="text-xs text-green-500 mt-2 text-center">.p12 and .pem file available in directory.</p>
                {% endif %}
            {% else %}
                <p class="text-sm text-gray-500">Sign the certificate first to enable export options.</p>
            {% endif %}
        </div>
    </div>
</div>

<div id="passwordModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white dark:bg-s1-800 rounded-lg shadow-xl p-6 w-96 border dark:border-s1-700">
        <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">Root CA Authorization</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Enter the Root CA password to sign <strong>{{ fqdn }}</strong>.</p>
        
        <form action="{{ url_for('sign_root', fqdn=fqdn) }}" method="POST">
            <label class="block text-xs uppercase font-bold text-gray-500 mb-1">Password</label>
            <input type="password" name="password" class="w-full p-2 mb-6 rounded border dark:bg-s1-900 dark:border-s1-700 dark:text-white focus:ring-2 focus:ring-s1-500 outline-none" autofocus>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="document.getElementById('passwordModal').classList.add('hidden')" class="px-4 py-2 rounded border dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-s1-700 text-gray-700 dark:text-gray-300 transition">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-s1-500 hover:bg-s1-400 text-white rounded shadow transition">Sign Certificate</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}